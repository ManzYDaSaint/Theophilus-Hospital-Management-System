// Prisma schema for Hospital Management System
generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Role model for RBAC
model Role {
  id          String   @id @default(uuid())
  name        String   @unique // Admin, Doctor, Nurse, Pharmacist, Receptionist
  description String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("roles")
}

// User model for authentication and authorization
model User {
  id                String     @id @default(uuid())
  email             String     @unique
  password          String // bcrypt hashed
  firstName         String
  lastName          String
  phoneNumber       String?
  roleId            String
  role              Role       @relation(fields: [roleId], references: [id])
  isActive          Boolean    @default(true)
  lastLogin         DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  visits            Visit[]    @relation("DoctorVisits")
  prescriptions     Prescription[]
  auditLogs         AuditLog[]
  transactions      Transaction[]
  expenses          Expense[]

  @@index([email]) 
  @@index([roleId])
  @@map("users")
}

// Patient model
model Patient {
  id               String    @id @default(uuid())
  firstName        String
  lastName         String
  dateOfBirth      DateTime
  gender           String    // Male, Female, Other
  phoneNumber      String
  address          String?
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  visits           Visit[]
  transactions     Transaction[]

  @@index([phoneNumber])
  @@map("patients")
}

// Visit model
model Visit {
  id              String       @id @default(uuid())
  patientId       String
  patient         Patient      @relation(fields: [patientId], references: [id])
  doctorId        String
  doctor          User         @relation("DoctorVisits", fields: [doctorId], references: [id])
  visitDate       DateTime     @default(now())
  chiefComplaint  String       
  vitalSigns      String?       // JSON: BP, Temp, Pulse, etc.
  notes           String?      
  status          String       @default("In Progress") // In Progress, Completed, Cancelled
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  diagnoses       Diagnosis[]
  prescriptions   Prescription[]

  @@index([patientId])
  @@index([doctorId])
  @@index([visitDate])
  @@map("visits")
}

// Diagnosis model
model Diagnosis {
  id          String   @id @default(uuid())
  visitId     String
  visit       Visit    @relation(fields: [visitId], references: [id], onDelete: Cascade)
  icdCode     String?  // ICD-10 code
  description String   
  notes       String?  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([visitId])
  @@map("diagnoses")
}

// Prescription model
model Prescription {
  id           String   @id @default(uuid())
  visitId      String
  visit        Visit    @relation(fields: [visitId], references: [id], onDelete: Cascade)
  prescribedBy String
  doctor       User     @relation(fields: [prescribedBy], references: [id])
  medication   String
  dosage       String
  frequency    String
  duration     String
  quantity      Int
  instructions  String?  
  status        String   @default("Active") // Active, Completed, Cancelled
  totalAmount   Decimal?
  paymentStatus String   @default("Pending") // Pending, Paid, Cancelled
  paidAt        DateTime?
  transactionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([visitId])
  @@index([prescribedBy])
  @@index([paymentStatus])
  @@map("prescriptions")
}

// Pharmacy stock model
model PharmacyStock {
  id              String   @id @default(uuid())
  medicationName  String   @unique
  description     String?  
  category        String?  // Antibiotic, Painkiller, etc.
  currentStock    Int      @default(0)
  minimumStock    Int      @default(10)
  reorderLevel    Int      @default(10)
  costPrice       Decimal // Cost per unit
  sellingPrice    Decimal // Selling price per unit
  unitPrice       Decimal // Legacy field, kept for compatibility
  expiryDate      DateTime?
  supplier        String?
  batchNumber     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([medicationName])
  @@map("pharmacy_stock")
}

// Audit log for sensitive operations
model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String   // LOGIN, CREATE_PATIENT, UPDATE_PATIENT, DELETE, etc.
  entity      String   // Patient, User, Visit, etc.
  entityId    String?
  details     String?   // JSON with additional details
  ipAddress   String?
  userAgent   String?  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// Transaction model for financial tracking
model Transaction {
  id            String   @id @default(uuid())
  type          String   // SALE, EXPENSE, PAYMENT, REFUND
  category      String   // PHARMACY, CONSULTATION, LAB, EQUIPMENT, SALARY, UTILITIES
  amount        Decimal
  description   String   
  referenceId   String?  // Links to Prescription, Visit, Expense, etc.
  referenceType String?  // Prescription, Visit, Expense
  paymentMethod String?  // Cash, Card, Insurance
  createdBy     String
  user          User     @relation(fields: [createdBy], references: [id])
  patientId     String?
  patient       Patient? @relation(fields: [patientId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([type])
  @@index([category])
  @@index([createdAt])
  @@index([patientId])
  @@map("transactions")
}

// Expense model for operational expenses
model Expense {
  id          String   @id @default(uuid())
  category    String   // SALARY, UTILITIES, EQUIPMENT, MAINTENANCE, SUPPLIES, RENT
  amount      Decimal
  description String   
  vendor      String?
  invoiceNo   String?
  date        DateTime
  createdBy   String
  user        User     @relation(fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([date])
  @@index([createdBy])
  @@map("expenses")
}
